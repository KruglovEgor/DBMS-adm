Вот подробный конспект по теме "Выполнение операций и восстановление данных в СУБД", охватывающий ключевые концепции, такие как буферизация данных, журналирование и контрольные точки.

---

### 1. Выполнение операций и синхронизация данных

При выполнении операций в базе данных PostgreSQL важно поддерживать согласованность между различными уровнями памяти:
- **Файлы данных** — основной источник хранения на диске.
- **Буферное пространство** — временное хранилище в оперативной памяти (RAM), которое уменьшает частоту операций с диском.
- **Адресное пространство транзакции** — область в памяти, где хранятся данные, используемые в рамках текущей транзакции.

#### Основные операции синхронизации:
- **M ← D(Obj)** — загрузка страницы, содержащей объект, с диска в буфер.
- **D ← M(Obj)** — сохранение страницы с изменениями на диск из буфера.
- **T(v, Tx) ← M(Obj)** — копирование объекта в переменную транзакции.
- **WriteLog** — запись изменений в журнал транзакций.

Пример выполнения операции **UPDATE**:
```sql
BEGIN;
UPDATE ROOM SET Room_Num = 1331 WHERE Room_Num = 374;
UPDATE ROOM SET Room_Num = 1330 WHERE Room_Num = 375;
COMMIT;
```
Каждое изменение сохраняется в буферной памяти до завершения транзакции, после чего фиксируется на диске.

### 2. Журнал отмены (UNDO Log)

**Журналирование** необходимо для предотвращения несогласованности данных при сбоях. PostgreSQL ведет UNDO-журнал, в котором фиксируются все изменения. Записи в журнале помогают восстановить исходные значения, если транзакция не завершена или произошел сбой.

#### Основные записи в UNDO Log:
- **BEGIN Tx** — начало транзакции.
- **Tx: R, old_val** — изменение значения, где `R` — объект, `old_val` — старое значение.
- **COMMIT Tx** — успешное завершение транзакции.
- **ABORT Tx** — преждевременное завершение транзакции.

#### Правила записи в UNDO Log:
1. Запись об изменении данных записывается в журнал **до** того, как данные сохраняются на диск.
2. **COMMIT Tx** записывается в журнал **после** синхронизации буферов с файлами данных.

**Пример работы UNDO Log**:
1. Транзакция изменяет значение объекта, и эта операция сохраняется в журнал.
2. Если транзакция не завершена, система использует UNDO Log для восстановления данных, отменяя незавершенные изменения.

### 3. Восстановление данных с помощью UNDO Log

Процесс восстановления данных включает следующие шаги:
1. СУБД анализирует журнал от новых записей к старым.
2. Выделяются две группы транзакций:
   - **Группа 1** — транзакции, для которых зафиксировано `COMMIT`.
   - **Группа 2** — транзакции с `ABORT` или незавершенные.
3. Для транзакций из группы 2 выполняется отмена изменений, восстанавливая исходные значения.

После восстановления данных для всех незавершенных транзакций записывается `ABORT Tx`.

### 4. Контрольные точки (Checkpoints)

**Контрольная точка** — это точка синхронизации, при которой данные из буферов записываются на диск. Она позволяет ускорить процесс восстановления, так как журнал можно анализировать с последней контрольной точки, а не с самого начала работы базы данных.

#### Создание контрольной точки:
1. В журнал добавляется запись `START CHKn`, указывающая начало создания контрольной точки.
2. Система ждет завершения всех транзакций, начатых до контрольной точки.
3. В журнал добавляется запись `END CHKn`, фиксируя завершение создания контрольной точки.
4. Записи перед `START CHKn` и с `END CHKn` могут быть удалены.

### 5. UNDO Log и контрольные точки

Контрольные точки упрощают работу UNDO Log:
- Если встречается `END CHKn`, значит установка завершена, и дальнейший анализ проводится от этой точки.
- Если встречается `START CHKn` без `END CHKn`, это означает, что установка была прервана. В этом случае анализ продолжается до первой записи самой ранней транзакции, начавшейся перед `START CHKn`.

### 6. Недостатки UNDO Log

Основные недостатки UNDO Log:
- Транзакция не может быть завершена (запись `COMMIT` не фиксируется), пока все изменения не будут записаны в файлы данных.
- Высокая нагрузка на операции ввода-вывода с диском из-за частой синхронизации данных.

---

Этот конспект охватывает основные концепции журналирования, восстановления данных и контрольных точек в PostgreSQL, позволяя понять, как СУБД поддерживает согласованность и целостность данных при сбоях.